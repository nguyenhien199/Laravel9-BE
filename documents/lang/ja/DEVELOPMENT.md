# BUILD AND DEPLOY

_`Base-Image`ã¯`ãƒ™ãƒ¼ã‚¹Dockerã‚¤ãƒ¡ãƒ¼ã‚¸`ã®ç•¥ã§ã™_  
_`App-Image`ã¯`ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³Dockerã‚¤ãƒ¡ãƒ¼ã‚¸`ã®ç•¥ã§ã™_  

ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ: Developmentç’°å¢ƒç”¨ã®`App-Image`ã®æ§‹ç¯‰ã¨ãƒ‡ãƒ—ãƒ­ã‚¤ã€‚

**ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ãƒ«ãƒ¼ãƒˆã‹ã‚‰å§‹ã‚ã¦ã€æ¬¡ã®æ‰‹é †ã‚’å®Ÿè¡Œã—ã¾ã™:**

## #ã‚¹ãƒ†ãƒƒãƒ— 0: åˆæœŸåŒ– (`Base-Image`ã®ãƒ“ãƒ«ãƒ‰)

2æ–¹æ³•:

- æ–¹æ³• 1: `Base-Image`ã‚’æ‰‹å‹•ã§ãƒ“ãƒ«ãƒ‰ã™ã‚‹ - æ¬¡ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«å¾“ã£ã¦ãã ã•ã„:
  [/docker/base/BUILD-BASE.md](../../../docker/base/lang/ja/BUILD-BASE.md)ã€‚

- æ–¹æ³• 2: `Base-Image`ã‚’è‡ªå‹•çš„ã«ãƒ“ãƒ«ãƒ‰ã™ã‚‹ - `#ã‚¹ãƒ†ãƒƒãƒ— 3`ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

> ãŸã ã—ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’åˆã‚ã¦é–‹å§‹ã™ã‚‹ã¨ãã¯ã€`#æ–¹æ³• 1`ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ã—ã¦ã€`Base-Image`ã®ç’°å¢ƒå¤‰æ•° (`.env`) ã‚’æ§‹æˆã™ã‚‹æ–¹æ³•ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

## #ã‚¹ãƒ†ãƒƒãƒ— 1: ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã®æ§‹æˆ

- ç’°å¢ƒãƒ•ã‚¡ã‚¤ãƒ« (å¿…é ˆã®åå‰ `.env`) ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã™:
```bash
cp ./.env-local.env ./.env
```

- ç’°å¢ƒã«åˆã‚ã›ã¦æ§‹æˆæƒ…å ±ã‚’å¤‰æ›´ã—ã€ãƒ–ãƒ­ãƒƒã‚¯ã—ã¾ã™:
    + `## SAIL CONFIGURATION FOR DEVELOPMENT ##`
    + `## SUPERVISOR TURN ON/OFF SERVICE ##`
    + `## FOR APP ##`
    + ...

> ğŸ“**æ³¨è¨˜:**
> - `## SAIL CONFIGURATION FOR DEVELOPMENT ##`:
>>  + `COMPOSE_PROJECT_NAME`: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«åå‰ã‚’ä»˜ã‘ã¾ã™ï¼ˆDocker-Compose ã®å½¢å¼ã«å¾“ã„ã¾ã™ï¼‰ã€‚ ã“ã®å€¤ã¯ã€èµ·å‹•æ™‚ã« Container ã®åå‰ã®å‰ã«ã‚µãƒ¼ãƒ“ã‚¹åãŒä»˜åŠ ã•ã‚Œã¾ã™ã€‚
>>  + `COMPOSE_PROJECT_NETWORK`: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å†…éƒ¨ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«åå‰ã‚’ä»˜ã‘ã¾ã™ï¼ˆDocker-Compose ã«å¾“ã£ãŸå½¢å¼ï¼‰ã€‚ ã“ã®å€¤ã¯ Docker-Compose ã«ã‚ˆã£ã¦ä½œæˆã•ã‚Œã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã® Network ã¨ã„ã†åå‰ãŒä»˜ã‘ã‚‰ã‚Œã¾ã™ã€‚
>>  + `SAIL_FILES`: `docker-compose.yml` æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®çµ¶å¯¾ãƒ‘ã‚¹ã€‚_(ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ ãƒ«ãƒ¼ãƒˆã‹ã‚‰å§‹ã¾ã‚Šã€å…ˆé ­ã« `/` ãŒä»˜ã‹ãªã„)_ã€‚
>>  + `APP_IMAGE_NAME`: `App-Image`ã®åå‰ã€‚_(ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«é©åˆ‡ãªåå‰ã‚’ä»˜ã‘ã¾ã™ã€‚ä¾‹: `coffee/backend-app:latest`)_ã€‚
>>  + `APP_SERVICE`: Appã‚³ãƒ³ãƒ†ãƒŠã«å¯¾å¿œã™ã‚‹ `service` åã¯ `docker-compose.yml` ãƒ•ã‚¡ã‚¤ãƒ«ã§æ§‹æˆã•ã‚Œã¾ã™ã€‚
>>  + `APP_PORT`/`APP_PORT_SSL`: Appã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã®ãƒãƒ¼ãƒˆ (ãã‚Œãã‚Œ http ã¨ https)ã€‚
>>  + `SUPERVISOR_PORT`: ã“ã®ãƒãƒ¼ãƒˆã¯ã€Appã®ãã‚Œãã‚Œã®ã‚µãƒ¼ãƒ“ã‚¹/ãƒ—ãƒ­ã‚»ã‚¹ã‚’ç®¡ç†ã™ã‚‹`Supervisord`ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
>>  + `..._TAG`: ã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹ - `docker-compose.yml` ãƒ•ã‚¡ã‚¤ãƒ«å†…ã® `services` ã® Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ (ãƒãƒ¼ã‚¸ãƒ§ãƒ³) ã‚¿ã‚°ã«å¯¾å¿œã—ã¾ã™ã€‚
>>  + `..._FORWARD`: ã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹ - ä»–ã®ã‚µãƒ¼ãƒ“ã‚¹ã€ã¤ã¾ã‚Š`docker-compose.yml`ãƒ•ã‚¡ã‚¤ãƒ«ã®`services`ã§è¨­å®šã•ã‚ŒãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã‚‹ãƒãƒ¼ãƒˆã«å¯¾å¿œã—ã¾ã™ã€‚
>
> - `## SUPERVISOR TURN ON/OFF SERVICE ##`:
>>  + `SUV_WEB_SERVER`:          Supervisord ã®ç®¡ç†ä¸‹ã«ã‚ã‚‹ `Web-Server(Nginx/Apache)` ã‚µãƒ¼ãƒ“ã‚¹ã‚’æœ‰åŠ¹(`true`) - ç„¡åŠ¹(`false`) ã«ã—ã¾ã™ã€‚
>>  + `SUV_SCHEDULER`:           Supervisord ã®ç®¡ç†ä¸‹ã«ã‚ã‚‹ `Scheduler(Laravel)` ã‚µãƒ¼ãƒ“ã‚¹ã‚’æœ‰åŠ¹(`true`) - ç„¡åŠ¹(`false`) ã«ã—ã¾ã™ã€‚
>>  + `SUV_SCHEDULER_NUMPROCS`:  Supervisord ãŒä½œæˆã™ã‚‹ `Scheduler(Laravel)` ãƒ—ãƒ­ã‚»ã‚¹ã®æ•°ã§ã™ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: `SUV_SCHEDULER=false` ã®å ´åˆã¯ 0ã€`SUV_SCHEDULER=true` ã®å ´åˆã¯ 1ã€ç©ºã® `SUV_SCHEDULER_NUMPROCS`)ã€‚
>>  + `SUV_WORKER`:              Supervisord ã®ç®¡ç†ä¸‹ã«ã‚ã‚‹ `Worker(Laravel)` ã‚µãƒ¼ãƒ“ã‚¹ã‚’æœ‰åŠ¹(`true`) - ç„¡åŠ¹(`false`) ã«ã—ã¾ã™ã€‚
>>  + `SUV_WORKER_NUMPROCS`:     Supervisord ãŒä½œæˆã™ã‚‹ `Worker(Laravel)` ãƒ—ãƒ­ã‚»ã‚¹ã®æ•°ã§ã™ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: `SUV_WORKER=false` ã®å ´åˆã¯ 0ã€`SUV_WORKER=true` ã®å ´åˆã¯ 1ã€ç©ºã® `SUV_WORKER_NUMPROCS`)ã€‚
>
> - `## FOR APP ##`:
>>  + ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã®æ§‹æˆã¯ã€PHP ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®æ§‹æˆã§ã™ã€‚
>
>> - ã•ã‚‰ã«ã€ä»–ã®ã™ã¹ã¦ã®æ§‹æˆã¯åŒã˜ã¾ã¾ã«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
>> - ã‚³ãƒ”ãƒ¼ã—ãŸ `.env` ãƒ•ã‚¡ã‚¤ãƒ«å†…ã®æ³¨è¨˜ã‚’ã‚ˆãèª­ã‚“ã§ãã ã•ã„ã€‚

## #ã‚¹ãƒ†ãƒƒãƒ— 2: `sail` ã®æ¦‚è¦ã¨ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« (ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹)

### #`sail`ã®ã”ç´¹ä»‹

- `sail`: Laravel ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã® Docker é–‹ç™ºç’°å¢ƒã¨å¯¾è©±ã™ã‚‹ãŸã‚ã®è»½é‡ã®ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã§ã™ã€‚  
  è©³ç´°æƒ…å ±ã¯[ã“ã¡ã‚‰](https://laravel.com/docs/11.x/sail#introduction)ã‚’ã”è¦§ãã ã•ã„ã€‚

- `sail`: macOSã€Linuxã€Windows ([WSL2](https://learn.microsoft.com/en-us/windows/wsl/about) çµŒç”±) ã§ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã™ã€‚

- `docker/sail`: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«å«ã¾ã‚Œã‚‹ã®ã¯ Laravel Sail ã®ã‚³ãƒ”ãƒ¼ã§ã‚ã‚Šã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æ„å›³ã•ã‚ŒãŸç”¨é€”ã«åˆã‚ã›ã¦èª¿æ•´ã•ã‚Œã¦ã„ã¾ã™ã€‚  
  ä¾‹:  
    - `php-fpm`ã¨`nginx`ã‚’çµ„ã¿åˆã‚ã›ã¦ä½¿ç”¨ã™ã‚‹å ´åˆã®æ¨©é™ã«ä¸€è‡´ã™ã‚‹ã‚ˆã†ã«ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’`sail`ã‹ã‚‰`www-data`ã«è¨­å®šã—ã¾ã™ã€‚  
      _(Laravel Sail ã¯å…ƒã€…ã€`ubuntu`ã¨`apache2`ã®é–“ã®çµ±åˆã¨ã—ã¦ä½¿ç”¨ã•ã‚Œã¾ã—ãŸã€‚)_
    - `Base-Image` ãƒ“ãƒ«ãƒ‰ ã‚¹ãƒ†ãƒƒãƒ—ã¨ç›´æ¥å¯¾è©±ã—ã¦ã€é–‹ç™ºã‚¹ãƒ†ãƒƒãƒ—ã‚’ç°¡ç´ åŒ–ã§ãã¾ã™ã€‚

### #`sail`ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹

`sail`ã¯ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã§ã‚ã‚‹ãŸã‚ã€ç‰¹å®šã®æ¨©é™ã‚’ä»˜ä¸ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

`sail` ã®å®Ÿè¡Œå¯èƒ½ãªè¨­å®š:
```bash
bash ./docker/setup_sail.sh
```

- `sail`ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ãƒªã‚¹ãƒˆã®ã‚¯ã‚¤ãƒƒã‚¯ã‚¬ã‚¤ãƒ‰:
```bash
./docker/sail --help
```

## #ã‚¹ãƒ†ãƒƒãƒ— 3: ãƒ“ãƒ«ãƒ‰ - ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•ã—ã¾ã™

- ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¦`App-Image`ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¾ã™:
```bash
./docker/sail build --no-cache --memory=512M --progress=plain
```

> ğŸ“**æ³¨è¨˜:**
> - `--no-cache` : ãƒ“ãƒ«ãƒ‰æ™‚ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ç”¨ã—ãªã„ã§ãã ã•ã„ã€‚
> - `--memory=512M` : ãƒ“ãƒ«ãƒ‰ãƒ—ãƒ­ã‚»ã‚¹ã®Memoryåˆ¶é™ã‚’è¨­å®šã—ã¾ã™ã€‚
> - `--progress=plain` : Consoleç”»é¢ã§è©³ç´°ãªãƒ“ãƒ«ãƒ‰å±¥æ­´ã‚’ç¢ºèªã—ã¾ã™ã€‚
>> **æœ€åˆã®ãƒ“ãƒ«ãƒ‰æ™‚ã€ã¾ãŸã¯ `build`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã€`Base-Image`ã®ãƒ“ãƒ«ãƒ‰ãŒè‡ªå‹•çš„ã«æœ‰åŠ¹ã«ãªã‚Šã¾ã™ - `#ã‚¹ãƒ†ãƒƒãƒ— 0 / æ–¹æ³• 2`ã§ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚**  
>> æ¬¡ã«ã€`App-Image`ã‚’æ§‹ç¯‰ã™ã‚‹æ‰‹é †ã«é€²ã¿ã¾ã™ã€‚

- `sail` ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•ã—ã¾ã™:
```bash
./docker/sail up -d
```

> ğŸ“ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯æ‹¡å¼µã§ãã¾ã™:
> - `--build` : ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã™ã‚‹å‰ã«ã€`App-Image`ã®å†æ§‹ç¯‰ã‚’å¼·åˆ¶ã—ã¾ã™ã€‚
>> **æœ€åˆã®ãƒ“ãƒ«ãƒ‰ã§ã¯ã€`#ã‚¹ãƒ†ãƒƒãƒ— 0 / æ–¹æ³• 2`ã§ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒè¡¨ç¤ºã•ã‚Œã€`Base-Image`ã®ãƒ“ãƒ«ãƒ‰ã‚‚è‡ªå‹•çš„ã«ãƒˆãƒªã‚¬ãƒ¼ã•ã‚Œã¾ã™ã€‚**  
>> æ¬¡ã«ã€`App-Image`ã‚’ãƒ“ãƒ«ãƒ‰ã—ã€ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã™ã‚‹æ‰‹é †ã«é€²ã¿ã¾ã™ã€‚

> ğŸ”¥**é‡è¦:**
> - ã€ŒERROR [internal] load metadata for `docker.io/xxxyyy:latest`ã€ã¨ã„ã†ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯ã€`sudo`æ¨©é™ã‚’ä½¿ç”¨ã—ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚

## #å»¶é•·: 

- App bash ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™ (ãƒ¦ãƒ¼ã‚¶ãƒ¼: `www-data`):
```bash
./docker/sail bash
```

- App bash ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™ (ãƒ¦ãƒ¼ã‚¶ãƒ¼: `root`):
```bash
./docker/sail root-bash
```

- PHP ã®ä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹:
```bash
./docker/sail composer install --optimize-autoloader
```
